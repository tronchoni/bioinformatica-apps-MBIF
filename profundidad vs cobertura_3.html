<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador V2: Profundidad vs. Cobertura</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #3498db;
            --success: #27ae60;
            --warning: #e67e22;
            --bg: #f4f7f6;
            --danger: #e74c3c;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            color: var(--primary);
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        h1 { text-align: center; color: var(--primary); margin-bottom: 10px; }
        .subtitle { text-align: center; color: #7f8c8d; margin-bottom: 30px; font-size: 0.9em; }

        /* Layout de controles y stats */
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1.2fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (max-width: 768px) { .dashboard { grid-template-columns: 1fr; } }

        .controls, .stats-container {
            background: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
        }

        .control-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 0.9em; }
        input[type="range"] { width: 100%; cursor: pointer; }
        .val-display { float: right; color: var(--accent); font-weight: bold; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .stat-box {
            background: white;
            padding: 15px 10px;
            border-left: 4px solid var(--accent);
            border-radius: 4px;
            text-align: center;
        }
        .stat-box h3 { margin: 0; font-size: 0.8em; color: #7f8c8d; text-transform: uppercase; }
        .stat-box p { margin: 5px 0 0 0; font-size: 1.4em; font-weight: bold; color: var(--primary); }
        
        .formula { font-size: 0.75em; color: #95a5a6; font-style: italic; margin-top: 5px; }

        /* Visualizaci贸n del Genoma */
        .viz-wrapper { position: relative; }
        
        .viz-container {
            position: relative;
            margin-top: 20px;
            border: 1px solid #bdc3c7;
            background: white;
            cursor: crosshair; /* Indica que se puede inspeccionar */
        }

        #genome-track {
            height: 25px;
            background: #34495e;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ecf0f1;
            font-weight: bold;
            font-size: 0.8em;
            letter-spacing: 1px;
        }

        .alignment-viewer {
            position: relative;
            height: 220px;
            width: 100%;
            background: #f8f9fa;
            /* Quitamos borde superior para unirlo visualmente al histograma */
            border-bottom: 1px solid #bdc3c7;
            overflow: hidden;
        }

        .read {
            position: absolute;
            height: 5px;
            background-color: var(--accent);
            border-radius: 1px;
            opacity: 0.6;
            pointer-events: none; 
        }
        
        /* Histograma de cobertura */
        #coverage-map {
            height: 80px; /* Un poco m谩s alto para que se vea mejor arriba */
            width: 100%;
            display: flex;
            align-items: flex-end;
            background: #f0f3f4;
            border-bottom: 1px dashed #bdc3c7; /* Separador visual sutil */
            padding-top: 1px;
        }
        .cov-bar-group {
            flex: 1;
            height: 100%;
            display: flex;
            align-items: flex-end;
            pointer-events: none;
        }
        .cov-bar { 
            width: 100%; 
            background: var(--success); 
            opacity: 0.8;
            transition: height 0.1s; 
        }
        .cov-bar.zero { background: var(--danger); opacity: 0.3; height: 2px !important; }

        /* Tooltip CORREGIDO */
        #hover-tooltip {
            position: fixed; /* CAMBIO CLAVE: Fixed evita problemas de scroll y offset */
            display: none;
            background: rgba(44, 62, 80, 0.98);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 0.85em;
            pointer-events: none;
            z-index: 1000; /* Z-index alto para asegurar que flote sobre todo */
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            border: 1px solid #34495e;
            transform: translate(15px, 15px); /* Offset desde el puntero */
        }
        #hover-tooltip strong { color: var(--accent); }

        .alert-resize {
            font-size: 0.8em; color: var(--warning); font-style: italic; margin-top: -10px; margin-bottom: 10px;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Simulador de Secuenciaci贸n - @tronchoni</h1>
    <p class="subtitle">Visualizaci贸n interactiva de Profundidad y Cobertura</p>

    <div class="dashboard">
        <div class="controls">
            <h3>Par谩metros</h3>
            
            <div class="control-group">
                <label>Tama帽o Genoma (bases): <span id="val-genome" class="val-display">100</span></label>
                <input type="range" id="genomeSize" min="100" max="5000" step="100" value="100">
                <p class="alert-resize" id="resize-alert" style="display:none;">锔 Cambiar el tama帽o reinicia los reads.</p>
            </div>

            <div class="control-group" style="border-top: 1px solid #bdc3c7; padding-top: 15px;">
                <label>N煤mero de Reads: <span id="val-reads" class="val-display">0</span></label>
                <input type="range" id="numReads" min="0" max="500" value="0">
            </div>

            <div class="control-group">
                <label>Longitud del Read (L): <span id="val-len" class="val-display">20</span></label>
                <input type="range" id="readLength" min="10" max="150" step="5" value="20">
            </div>

            <button onclick="fullReset()" style="background:var(--primary); color:white; border:none; padding:10px 20px; cursor:pointer; border-radius:4px; width:100%;">Reset Total</button>
        </div>

        <div class="stats-container">
            <h3>M茅tricas Globales</h3>
            <div class="stats-grid">
                <div class="stat-box" style="border-color: var(--accent);">
                    <h3>Profundidad Media</h3>
                    <p id="res-depth">0.00 X</p>
                    <div class="formula">$$ (N \times L) / G $$</div>
                </div>
                <div class="stat-box" style="border-color: var(--success);">
                    <h3>Cobertura (Breadth)</h3>
                    <p id="res-coverage">0%</p>
                    <div class="formula">% bases cubiertas >0X</div>
                </div>
                <div class="stat-box" style="border-color: var(--danger);">
                    <h3>Gaps (Sin cubrir)</h3>
                    <p id="res-gaps">100 bases</p>
                    <div class="formula">Bases a 0X</div>
                </div>
            </div>
             <p style="margin-top: 15px; font-size: 0.9em; text-align: center;">
                 <em> Pasa el rat贸n por la visualizaci贸n inferior para ver la profundidad exacta en cada base.</em>
             </p>
        </div>
    </div>

    <div class="viz-wrapper">
        <div id="hover-tooltip"></div>

        <div class="viz-container" id="main-viz-container">
            <div id="genome-track">GENOMA DE REFERENCIA (Escala Lineal)</div>
            
            <div id="coverage-map"></div>

            <div id="alignment-viewer" class="alignment-viewer"></div>
        </div>
    </div>
</div>

<script>
    // --- Variables de Estado Globales ---
    let state = {
        genomeSize: 100,
        numReads: 0,
        readLength: 20,
        readsData: [], 
        baseCounts: [] 
    };

    // --- Referencias DOM ---
    const controls = {
        genomeSize: document.getElementById('genomeSize'),
        numReads: document.getElementById('numReads'),
        readLength: document.getElementById('readLength'),
        resizeAlert: document.getElementById('resize-alert')
    };
    const displays = {
        genome: document.getElementById('val-genome'),
        reads: document.getElementById('val-reads'),
        len: document.getElementById('val-len')
    };
    const stats = {
        depth: document.getElementById('res-depth'),
        cov: document.getElementById('res-coverage'),
        gaps: document.getElementById('res-gaps')
    };
    const viz = {
        container: document.getElementById('main-viz-container'),
        viewer: document.getElementById('alignment-viewer'),
        covMap: document.getElementById('coverage-map'),
        tooltip: document.getElementById('hover-tooltip')
    };

    // --- Inicializaci贸n y Eventos ---
    controls.genomeSize.addEventListener('input', handleGenomeResize);
    controls.numReads.addEventListener('input', handleReadsChange);
    controls.readLength.addEventListener('input', handleLengthChange);

    // Eventos para el Tooltip
    viz.container.addEventListener('mousemove', updateTooltip);
    viz.container.addEventListener('mouseleave', () => {
        viz.tooltip.style.display = 'none';
    });

    function init() {
        state.baseCounts = new Array(state.genomeSize).fill(0);
        updateUIValues();
        renderHistogramStructure();
    }

    // --- Manejadores de Cambio (Handlers) ---

    function handleGenomeResize() {
        const newSize = parseInt(controls.genomeSize.value);
        if (newSize === state.genomeSize) return;

        state.genomeSize = newSize;
        state.numReads = 0;
        state.readsData = [];
        state.baseCounts = new Array(state.genomeSize).fill(0);
        
        controls.numReads.value = 0; 
        controls.resizeAlert.style.display = "block"; 
        setTimeout(() => controls.resizeAlert.style.display = "none", 3000);

        updateUIValues();
        renderHistogramStructure(); 
        fullRenderAndUpdate();
    }

    function handleLengthChange() {
        state.readLength = parseInt(controls.readLength.value);
        state.readsData = [];
        generateReads(state.numReads);
        updateUIValues();
        fullRenderAndUpdate();
    }

    function handleReadsChange() {
        const newReadCount = parseInt(controls.numReads.value);
        
        if (newReadCount > state.numReads) {
            generateReads(newReadCount - state.numReads);
        } else if (newReadCount < state.numReads) {
            state.readsData = state.readsData.slice(0, newReadCount);
        }
        state.numReads = newReadCount;
        updateUIValues();
        fullRenderAndUpdate();
    }


    // --- L贸gica Principal ---

    function fullReset() {
        controls.genomeSize.value = 100;
        controls.numReads.value = 0;
        controls.readLength.value = 20;
        handleGenomeResize();
    }

    function updateUIValues() {
        displays.genome.innerText = state.genomeSize.toLocaleString();
        displays.reads.innerText = state.numReads;
        displays.len.innerText = state.readLength;
    }

    function generateReads(countToAdd) {
        for (let i = 0; i < countToAdd; i++) {
            let maxStart = Math.max(1, state.genomeSize - state.readLength + 5);
            let startPos = Math.floor(Math.random() * maxStart);
            let row = Math.floor(Math.random() * 30); 
            state.readsData.push({ start: startPos, row: row });
        }
    }

    function calculateBaseCounts() {
        state.baseCounts.fill(0);
        state.readsData.forEach(read => {
            for(let k=0; k < state.readLength; k++) {
                let pos = read.start + k;
                if(pos >= 0 && pos < state.genomeSize) {
                    state.baseCounts[pos]++;
                }
            }
        });
    }

    function calculateGlobalStats() {
        let theoreticalDepth = (state.numReads * state.readLength) / state.genomeSize;
        stats.depth.innerText = theoreticalDepth.toFixed(2) + " X";

        let basesCovered = state.baseCounts.filter(c => c > 0).length;
        let coveragePercent = (basesCovered / state.genomeSize) * 100;
        stats.cov.innerText = coveragePercent.toFixed(1) + "%";
        
        let gaps = state.genomeSize - basesCovered;
        stats.gaps.innerText = gaps.toLocaleString() + " bases";
    }

    // --- Renderizado (Visualizaci贸n) ---

    function fullRenderAndUpdate() {
        calculateBaseCounts();
        calculateGlobalStats();
        renderReads();
        updateHistogramHeights();
    }

    function renderReads() {
        viz.viewer.innerHTML = '';
        const fragment = document.createDocumentFragment();

        state.readsData.forEach(read => {
            let el = document.createElement('div');
            el.className = 'read';
            
            let left = (read.start / state.genomeSize) * 100;
            let width = (state.readLength / state.genomeSize) * 100;
            if (width < 0.2) width = 0.2; 
            
            let top = read.row * 6; 

            el.style.left = left + '%';
            el.style.width = width + '%';
            el.style.top = top + 'px';
            
            fragment.appendChild(el);
        });
        viz.viewer.appendChild(fragment);
    }

    function renderHistogramStructure() {
        viz.covMap.innerHTML = '';
        const fragment = document.createDocumentFragment();
        for (let i = 0; i < state.genomeSize; i++) {
             let barGroup = document.createElement('div');
             barGroup.className = 'cov-bar-group';
             let bar = document.createElement('div');
             bar.className = 'cov-bar zero';
             bar.id = `cov-bar-${i}`; 
             barGroup.appendChild(bar);
             fragment.appendChild(barGroup);
        }
        viz.covMap.appendChild(fragment);
    }

    function updateHistogramHeights() {
        let maxDepth = Math.max(...state.baseCounts, 8);

        state.baseCounts.forEach((count, index) => {
             const bar = document.getElementById(`cov-bar-${index}`);
             if (!bar) return;

             if (count === 0) {
                 bar.className = 'cov-bar zero';
                 bar.style.height = ''; 
             } else {
                 bar.className = 'cov-bar';
                 let h = (count / maxDepth) * 100;
                 bar.style.height = h + '%';
             }
        });
    }

    // --- L贸gica del Tooltip CORREGIDA ---
    function updateTooltip(e) {
        if (state.genomeSize === 0) return;

        const rect = viz.container.getBoundingClientRect();
        const x = e.clientX - rect.left; 
        const width = rect.width;

        const percentage = Math.max(0, Math.min(1, x / width)); 
        let baseIndex = Math.floor(percentage * state.genomeSize);
        if (baseIndex >= state.genomeSize) baseIndex = state.genomeSize - 1;

        const exactDepth = state.baseCounts[baseIndex];

        viz.tooltip.innerHTML = `
            <div>Posici贸n Base: <strong>${(baseIndex + 1).toLocaleString()}</strong></div>
            <div style="font-size: 1.1em; border-top:1px solid #555; padding-top:4px; margin-top:4px;">
                Cobertura Local: <strong>${exactDepth} X</strong>
            </div>
        `;
        viz.tooltip.style.display = 'block';
        
        // Usamos clientX/Y para posicionamiento Fixed, funciona perfecto aunque haya scroll
        viz.tooltip.style.left = `${e.clientX}px`; 
        viz.tooltip.style.top = `${e.clientY}px`;
    }

    init();

</script>

</body>
</html>